---
title: 微服务架构可视化平台实践
date: 2018-11-22 16:32:28 +0800
tags: [架构, 可视化, AHAS]
categories: 架构
---

<a name="g230wm"></a>
### 为什么需要架构可视化
随着企业进行微服务架构改造，系统架构复杂度越来越高，架构变化日益频繁，微服务改造后的实际架构模型可能与预期已经产生了巨大差异，架构师或系统运维人员很难准确记忆所有资源实例的构成和交互情况；其次，系统架构在动态演化过程中可能引入了一些不可靠的因素，比如弱依赖变强依赖、局部容量不足、系统耦合过重等，给系统的稳定性带了极大的安全隐患。所以我们每次在面对系统改造、业务大促以及稳定性治理工作之前，都会通过梳理架构图的方式，呈现系统架构中个组件之间的交互方式，架构可视化能够清晰的协助我们识别架构中存在的问题以及建立高可用的系统。<!--more-->


![](https://cdn.nlark.com/yuque/0/2018/png/104361/1542956362235-c47820c3-d1a6-4470-8be3-343ed710ceb7.png#width=638)<br />（_Daniel Woods 在讲微服务时时的一张架构图）_

架构可视化后，可以给我们带来以下几点但不局限于此的优势：
* 确定系统边界


一张好的架构图，应该明确系统所包含的各个组件以及各个组件之间的核心调用关系，这些组件的集合就是系统的处理边界，系统架构的边界在一定程度上也反映了业务域的边界。
* 架构问题识别


基于高可用的架构准则，结合可视化的架构图，可以评估架构可能存在的安全风险，比如系统在容灾、隔离以及自愈维度下的健壮性。其次，一些架构链路可视化工具(比如鹰眼)在实际工作中确实大大提高了开发者排查与定位问题的效率。
* 提高系统可用性


有了系统架构的上下游依赖关系图，在故障发生时，开发人员可以借助依赖数据快速定位到问题的来源，极大缩短问题修复时间（MTTR）。借助架构图，我们还可以梳理出系统中存在的强弱依赖，在业务高峰期对弱依赖进行降级，或者针对系统依赖的各个组件进行故障模拟，以评测系统整体在面对局部故障的可靠性。

<a name="x8wvqr"></a>
### 常见架构可视化的做法
我们熟知的架构图是静态的停留在PPT上的，很多时候我们的架构已经发生了非常大的变化，但是我们还在使用那张看上去很经典却早已过时的架构图。长时间使用与实际架构不符的架构图对线上架构的认知的危害是巨大的，我们需要在脑海中不断更新对系统架构的视图，以保持对系统架构的敏感度。每年的大促或者重大系统改造成为我们梳理系统架构、对架构进行重新认知的机会，此刻我们需要通过各种工具查看系统的各个组件分布以及不同组件的内部与外部的依赖关系，这种梳理架构图的方法是最常用的方式，权且称之为“**手工绘制法**”。

手工经常干的事情，就有追求效率的同学使用计算机系统带来的自动化手段帮助自己做这件事情，比如我们常常看到的基于数据埋点的微服务可视化解决方案，这类架构可视化手段通常在分布式追踪、APM等监控领域使用较多，下图为某APM产品提供的应用维度架构可视化方案：<br />![](https://cdn.nlark.com/yuque/0/2018/png/104361/1542964309773-458512d9-ae12-464b-a562-33df8342ac54.png#width=747)<br />我们称这种可视化方式为“**埋点式感知法**”，架构组件的识别是依赖关键的核心类检测与埋点，此种方案存在以下弊端：
* 语言相关性：只要是系统埋点，与语言相关的特征基本就拜托不了，需要针对不同语言提供不同的依赖包；

* 不易维护：因为是对核心类的检测，当组件包做了重大变更时，需要同步变更；

* 不易扩展：因为是客户端识别方案，客户端一旦开放出去，新组件的支持只能等待用户更新组件；

* 规模受限：客户端识别的另一个缺点是算法受限，服务端进行识别，可以借助大数据分析等手段更有效准确的识别；


还有一种自动化架构感可视化方法，我们称之为“**无界架构感知**”，是一种语言无关性的架构识别方案，其采用采集用户主机上的进程和容器的元数据、监控数以及网路数据的最最基础的数据，在服务端构建架构图。

<a name="sak3aa"></a>
### 我们设计架构可视化的理念
为了最大限度上降低用户进行架构可视化的成本，我们采用了无界架构感知-应用无侵入的方式微服务进行可视化，通过采集进程数据与网络调用数据，构建进程间的网络调用关系，构建微服务的架构信息。用户只需要安装我们AHAS Agent探针，即可完成架构可视化操作；对于阿里云云原生系统，我们提供了自动化安装方式，而无需登录机器。

<a name="ow5ucr"></a>
#### 核心本质
软件架构可视化的核心点是寻找在软件体系结构中有意义和有效的元素视图以及这些元素之间的关系。我们认为一款优秀的软件架构可视化产品应该帮助用户排除掉不重要的信息，给用户呈现出对他们有价值的视图，特别是在微服务架构下庞大而复杂的调用关系链场景中。这里面的核心点是**有意义**和**有效**，要做到这两点，首先需要识别什么是有意义和有效的元素和关系，我们在此领域做的事情归纳起来就是“**识别**”，识别机器上的每个进程是什么，发生的网络调用远端是什么，唯有知晓了这些元素是什么我们才有理由和依据来判断是否对用户有意义以及其在用户架构中的重要程度。

在梳理了大量架构图，我们发现用户关心的架构元素主要分为三类：
1. 自己的应用服务；

1. 应用对外部的资源依赖；

1. 服务器本身的信息。 


应用对外部资源的依赖通常以其它应用和通用中间件或者存储服务两种形式存在。故我们将需要识别的进程分为：应用服务和常见的组件服务（比如redis、mysql等），这些组件服务又分为用户自建的服务和使用公有云提供的服务，特别是对于Cloud Native应用来说，云服务的识别显得格外重要。<br />目前，我们提供了20种阿里云云服务的识别以及包含mysql、redis、Tomcat等常见的21种三方服务组件，此组件库还在不断扩张中，目的就是最大限度的知晓架构中的元素到底是什么。

![](https://cdn.nlark.com/yuque/0/2018/png/104361/1542958237398-de68d1b7-ef29-46b7-879b-41cb37b3c8a5.png#width=747)<br />     （图中展示了 通过识别服务识别出来的nginx、redis组件以及阿里云中的Mysql服务和AHAS服务）

![](https://cdn.nlark.com/yuque/0/2018/png/104361/1542958281395-8bb05ff4-0958-474d-8f04-546cbf8a0456.png#width=747)<br />（图中展示了节点详情的请求流向以及节点的监控等基本信息）

![](https://cdn.nlark.com/yuque/0/2018/png/104361/1542963012342-42798fda-e169-4f2a-aaa8-481b1ff6d98b.png#width=747)<br />(图中展示了识别的主机上的部分进程信息)
<a name="xwhcne"></a>
#### 架构分层
我们同样认为架构可视化的有效性跟人的认知层次有关，架构可视化的重点是确定该工具是否更好的支持自顶向下方法、自下而上方法或者两者的结合。开发者更关心应用维度上的架构，架构师或者管理者更关心整体系统架构。所以需要针对不用的使用者提供不同层次的架构可视化视角。理想的架构图需要支持宏观维度以及不断下钻下的微观视角，我们对架构进行了分层设计，目前分为进程层、容器层和主机层，后期我们可能会继续上扩或者下钻支持地域层或者服务层。

<a name="cvcnys"></a>
#### 架构回溯
没有哪个系统的架构是一成不变的，系统架构会随着系统的版本迭代不断进行演化。所以对架构可视化操作，还需要具备随着时间的推移可对架构信息进行自动更新已经回溯的能力。在我们提供的[架构感知](https://www.aliyun.com/product/ahas)产品中默认架构图会随着时间自动刷新，同时支持对历史的回溯，你可以选择历史中的某一刻查看架构信息，比如，重大版本的变更时，发布前与发布后的系统架构是否发生了违背一些高可用原则的问题，抑或排查是否出现了不该有的依赖问题。<br />![](https://cdn.nlark.com/yuque/0/2018/png/104361/1542960362139-534dd303-c1b7-493a-8685-ac502e356028.png#width=747)

<a name="l3b8al"></a>
#### 可见可得
架构可视化解决了可见的问题，但当我们从架构图中发现了问题需要解决时，架构图还应该给我们提供便利的可交互操作入口，让我们可以完成问题发现与解决的闭环。比如通过架构感知监控到了某个应用的流量非常大，我们需要对应用进行限流或者预案，那么通过架构图，我们应该是可以完成我们期望执行的操作。在架构图中融入可以交互的运维操作，让我们从看到到操作，再到问题恢复后体现在图中，这就像计算机发展史上从命令行视图到窗口视图的转变。

<a name="mtfgyk"></a>
### 我们对架构可视化的定位
**架构可视化不是目的，只是实现系统高可用性的手段**。借助架构感知采集到的架构数据，在识别了用户使用的组件（我们对mysql、redis、mq等的统称)后，我们借助这些组件以及与组件匹配的故障库，可以给用户自动推荐这些组件可能遇到的故障，配合我们提供的[评测服务](https://www.aliyun.com/product/ahas)让用户更方便地对组件进行各种故障的模拟与演练，以提高系统的健壮性。其次，通过架构感知识别Java Application 应用，如果发现其负载较高，配合我们提供的[限流降级](https://www.aliyun.com/product/ahas)（阿里巴巴开源的Sentinel商业版）功能，为服务的持续可用性保驾护航。


![](https://cdn.nlark.com/yuque/0/2018/gif/104361/1542969119301-c0372346-6922-4537-a611-1e772bee351f.gif#width=747)<br />（白屏化安装AHAS探针）<br />
<br />![](https://cdn.nlark.com/yuque/0/2018/gif/104361/1542971799291-1e0987da-79c4-4e2d-b9d3-4e847a9c82eb.gif#width=747)<br />（如何借助架构感知进行系统限流配置）<br />我们对AHAS的定位是一款数据分析型的高可用保障产品，帮助云原生架构系统实现高可用能力的提升。架构可视化是我们给用户提供的高效运维和管控的窗口，我们期望通过丰富的云原生数据体系配合架构图的可视化以及可操作性，建立起以应用为中心的运维一体化平台。在未来，我们会加强与其它云服务的集成，比如监控、容器服务，以丰富架构感知的数据维度；其次，会在数据的深度挖掘和智能化消费上投入更多精力，真正让数据成为企业的核心价值，让数据成为保障业务的稳定性的利器。

产品体验连接：[https://www.aliyun.com/product/ahas](https://www.aliyun.com/product/ahas)




